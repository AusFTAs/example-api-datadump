<!DOCTYPE html>
<html>
<head>
  <title>Dumping Example</title>
  <meta charset="UTF-8">
  <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
  <!-- look and feel -->
  <link rel="stylesheet" type="text/css" href="//ausftas.github.io/example-api-common/style.css">
  <link rel="stylesheet" type="text/css" href="http://blog.dfilimonov.com/github-ribbons-css/ribbons.css">
  <script src="//ausftas.github.io/example-api-common/style.js"></script>
  <!-- shared sources -->
  <script src="//ausftas.github.io/example-api-common/common.js"></script>
  <!-- excel writing -->
  <script src="http://oss.sheetjs.com/js-xlsx/shim.js"></script>
  <script src="http://oss.sheetjs.com/js-xlsx/jszip.js"></script>
  <script src="http://oss.sheetjs.com/js-xlsx/xlsx.js"></script>
</head>
<body>
  <div id="header"></div>
  
  <div id="example" class="content">
    <h1>API Stats Dump Example</h1>
  
    <div id="loading">
      Please wait while it loads.
    </div>
    <!-- ----------------------------------------------------------------- -->
    <!-- Part 1: Selection of agreeement, country -->
    <!-- ----------------------------------------------------------------- -->
    <div id="countries" style="display: hide;">
      <h2>Select Country And Year</h2>
      Please select a country:
      <select id="countrySelection">
        <option value="AUS">Australia</option>
        <option value="CHN">China</option>
        <option value="JPN">Japan</option>
        <option value="KOR">South Korea</option>
      </select>

      <div id="years" style="display: hide;">
        Please select a year:
        <select id="yearSelection">
          <option>2012</option>
          <option>2013</option>
          <option>2014</option>
          <option>2015</option>
          <option>2016</option>
        </select>
        <br />
        <button id="dumpYear">Dump</button>
      </div>
    </div>
    <script>
      // we will have populated this by the end
      var countries = null;
      var hierarchy = null;
      var selectedYear = null;
      var selectedCountry = null;
      
      // load and show a list of agreements
      $(document).ready(function()
      {
        $.invoke('/tariffs/hierarchy', function(hierarchy_)
        {
          hierarchy = hierarchy_;
          $.invoke('/stats/countries', function(countries_)
          {
            countries = countries_;
            $('#years').show();
            $('#yearSelection').change();
            $('#countrySelection').change();
            $('#loading').hide();
          });
        });
      });
      $('#countrySelection').change(function()
      {
        selectedCountry = $('#countrySelection').val();
      });
      $('#yearSelection').change(function()
      {
        selectedYear = $('#yearSelection').val();
      });
    </script>
    
    <!-- ----------------------------------------------------------------- -->
    <!-- Part 2: Download data -->
    <!-- ----------------------------------------------------------------- -->
    
    <div id="loadingData" style="display: none;">
      <h2>Downloading...</h2>
      <div id="loadingIndicator"></div>
    </div>
    
    <script>
      var headingData = {};
      
      function updateLoading()
      {
        $('#loadingIndicator').html(Object.keys(headingData).filter(function(f){return headingData[f] === false;}).sort().join(' '));
      }
      
      $('#dumpYear').click(function()
      {
        $('#loadingData').show();
        $('#downloadData').hide();
        $('#countries').hide();
        
        Object.keys(hierarchy).filter(function(item){
          return hierarchy[item].type === 'heading';
        }).forEach(function(heading)
        {
          if (headingData[heading] === undefined)
          {
            headingData[heading] = false;
            $.invoke('/stats/' + selectedCountry + '/' + heading, function(headingData_)
            {
              headingData[heading] = headingData_;
              updateLoading();
              if (Object.keys(headingData).filter(function(f){return headingData[f] === false;}).length === 0)
              {
                dumpData();
              }
            }, function()
            {
              delete headingData[heading];
              console.error('NO DATA', heading);
              if (Object.keys(headingData).filter(function(f){return headingData[f] === false;}).length === 0)
              {
                dumpData();
              }
            });
          }
        });
        
        if (Object.keys(headingData).filter(function(f){return headingData[f] === false;}).length === 0)
        {
          dumpData();
        }
        
        updateLoading();
      });
  </script>
  
    <!-- ----------------------------------------------------------------- -->
    <!-- Part 3: Dump data -->
    <!-- ----------------------------------------------------------------- -->
  
    <div id="dumpingData" style="display: none;">
      <h2>Dumping...</h2>
    </div>
    
    <script src="formula.js"></script>
    <script src="psr.js"></script>
    
    <script>
      
      function dumpData()
      {
        $('#dumpingData').show();
        $('#loadingData').hide();
        
        // accumulate all data
        
        var headings = ['hs2012', 'description', 'countryCode', 'countryName', 'valueUSD', 'valueAUD', 'source', 'notes'];
        var output = [];
        
        Object.keys(headingData).sort().forEach(function(heading)
        {
          var data = headingData[heading];
          Object.keys(data).forEach(function(hs)
          {
            var hsdata = data[hs];
            if (!hsdata.import || !hsdata.import.WLD || !hsdata.import.WLD[selectedYear])
            {
              return;
            }
            else
            {
              Object.keys(hsdata.import).map(function(country)
              {
                var out = hsdata.import[country][selectedYear];
                if (out)
                {
                  out.hs2012 = hs;
                  out.description = hsdata.description;
                  out.countryCode = country;
                  out.countryName = countries[country].countryFullName;
                  if (hsdata.importNotes)
                  {
                    out.notes = hsdata.importNotes;
                  }
                  return out;
                }
                return false;
              }).filter(function(f){return f;})
                .sort(function(a,b){return a.rank - b.rank;})
                .map(function(o){delete o.rank; return o;})
                .forEach(function(o){output.push(o);});
            }
          });
        });
        
        output.forEach(function(row)
        {
          Object.keys(row).forEach(function(head)
          {
            if (headings.indexOf(head) === -1)
            {
              headings.push(head);
            }
          });
        });
        
        // write excel file
        
        var wb = {
          Sheets : {},
          SheetNames: []
        };
        
        var ws = {};
        
        var row = 0;
        headings.forEach(function (head, index)
        {
          ws[XLSX.utils.encode_cell({c: index, r: row})] = {
            t: 's',
            v: head
          };
        });
        row++;
        
        output.forEach(function(item)
        {
          Object.keys(item).forEach(function(head)
          {
            ws[XLSX.utils.encode_cell({c: headings.indexOf(head), r: row})] = {
              t: 's',
              v: item[head]
            };
          });
          row++;
        });
        
        ws['!ref'] = XLSX.utils.encode_range({
          s: {
            c: 0,
            r: 0
          },
          e: {
            c: headings.length,
            r: output.length + 1
          }
        });
        
        var ws_name = selectedCountry + '_' + selectedYear;
        wb.SheetNames.push(ws_name);
        wb.Sheets[ws_name] = ws;
        
        var wopts = {
          bookType: 'xlsx',
          bookSST:false,
          type:'binary'
        };
        
        downloadData(XLSX.write(wb, wopts), ws_name + '.xlsx');
      }
      
      function beautifyHSCode(code, showLabel)
      {
        var hscode = code.replace(/[^0-9]/g, '');
        switch (hscode.length)
        {
        case 0:
          return (showLabel ? 'Section ' : '') + code;
        case 1:
        case 2:
          return (showLabel ? 'Chapter ' : '') + hscode;
        case 3:
        case 4:
          return (showLabel ? 'Heading ' : '') + hscode;
        case 5:
        case 6:
          return (showLabel ? 'Subheading ' : '') + hscode.substr(0, 4) + '.' + hscode.substr(4);
        default:
          return (showLabel ? 'Item ' : '') + hscode.substr(0, 4) + '.' + hscode.substr(4, 2) + '.' + hscode.substr(6);
        }
      }
    </script>
    
    <div id="downloadData" style="display: none;">
      <h2>Download</h2>
      <a id="downloadLink">Download</a>
    </div>
    
    <script>
    function downloadData(data, filename)
    {
      // http://stackoverflow.com/questions/10473932/browser-html-force-download-of-image-from-src-dataimage-jpegbase64
      data = atob(data);
      var arraybuffer = new ArrayBuffer(data.length);
      var view = new Uint8Array(arraybuffer);
      for (var i=0; i<data.length; i++) {
          view[i] = data.charCodeAt(i) & 0xff;
      }
      try
      {
        // This is the recommended method:
        var blob = new Blob([arraybuffer], {type: 'application/octet-stream'});
      } catch (e) {
          // The BlobBuilder API has been deprecated in favour of Blob, but older
          // browsers don't know about the Blob constructor
          // IE10 also supports BlobBuilder, but since the `Blob` constructor
          //  also works, there's no need to add `MSBlobBuilder`.
          var bb = new (window.WebKitBlobBuilder || window.MozBlobBuilder);
          bb.append(arraybuffer);
          var blob = bb.getBlob('application/octet-stream'); // <-- Here's the Blob
      }
      var url = (window.webkitURL || window.URL).createObjectURL(blob);
      $('#downloadLink').attr('href', url);
      $('#downloadLink').attr('download', filename);
      $('#downloadData').show();
      $('#dumpingData').hide();
      $('#agreements').show();
    }
    </script>
  </div>
  <div id="footer"></div>
  
  
</body>
</html>
